<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>OMS trials</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div id="map"></div>
    <br>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoicm9iZXJ0b3BhZGlsbGEiLCJhIjoiY2w1dmlpdTVnMGExcTNvcGcwdjJ1Nm5uYiJ9.4mfOVOxWaV-NBRJ-YBFInQ';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v10',
            center: [-74.5, 40],
            zoom: 2,
            projection: 'globe'
        });

        map.on('style.load', () => {
            map.setFog({
                "range": [0.01, 8],
                "color": "#318FD4",
                "horizon-blend": 0,
                "high-color": "#245bde",
                "space-color": "#000000",
                "star-intensity": 0.04
            });
        });

        const geojson = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [55.18066451312415, 25.106067088437698]
                    },
                    properties: {
                        staticview: "https://maps.googleapis.com/maps/api/streetview?size=200x200&location=25.106067088437698,55.18066451312415&fov=80&heading=70&pitch=0&key=AIzaSyAitnO3GWiZ7Xr3g1Q1FAtykDcszBZTJPw",
                        title: 'Dong Hu Lu',
                        description: '169 Donghu Road, Wuchang District, Wuhan, Hubei, China'
                    }
                },
                {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [-122.414, 37.776]
                    },
                    properties: {
                        staticview: "https://maps.googleapis.com/maps/api/streetview?size=200x200&location=30.5599172376607,114.36094674019095&fov=80&heading=70&pitch=0&key=AIzaSyAitnO3GWiZ7Xr3g1Q1FAtykDcszBZTJPw",
                        title: 'Mapbox',
                        description: 'San Francisco, California'
                    }
                }
            ]
        };

        // add markers to map
        for (const feature of geojson.features) {
            // create a HTML element for each feature
            const el = document.createElement('div');
            const image = "<img src='" + feature.properties.staticview + "'>"
            el.className = 'marker';

            // make a marker for each feature and add it to the map
            new mapboxgl.Marker(el)
            
                .setLngLat(feature.geometry.coordinates)
                .setPopup(
                    new mapboxgl.Popup({ offset: 25 }) // add popups
                        .setHTML(
                            `${image}
                            <h3>${feature.properties.title}</h3><p>${feature.properties.description}</p>`
                        )
                )
                .addTo(map);
        }



        const secondsPerRevolution = 120;
        const maxSpinZoom = 5;
        const slowSpinZoom = 3;
        let userInteracting = false;
        let spinEnabled = true;
        let allowLocation = false;

        // Pause spinning on interaction
        map.on('mousedown', () => {
            userInteracting = true;
        });

        // Restart spinning the globe when interaction is complete
        map.on('mouseup', () => {
            userInteracting = false;
            spinGlobe();
        });
        // When animation is complete, start spinning if there is no ongoing interaction
        map.on('moveend', () => {
            spinGlobe();
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(setPosition, spinGlobe);
        }

        function setPosition(position) {
            map.flyTo({
                center: [
                    position.coords.longitude,
                    position.coords.latitude
                ],
                zoom: 4,
                essential: true
            });
            allowLocation = true;
        }

        function spinGlobe() {
            const zoom = map.getZoom();
            if (!allowLocation) {
                if (spinEnabled && !userInteracting && zoom < maxSpinZoom) {
                    let distancePerSecond = 360 / secondsPerRevolution;
                    if (zoom > slowSpinZoom) {
                        // Slow spinning at higher zooms
                        const zoomDif =
                            (maxSpinZoom - zoom) / (maxSpinZoom - slowSpinZoom);
                        distancePerSecond *= zoomDif;
                    }
                    const center = map.getCenter();
                    center.lng -= distancePerSecond;
                    map.easeTo({ center, duration: 1000, easing: (n) => n });
                }
            }
        }

    </script>

</body>

</html>